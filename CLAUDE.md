# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

MockTraceAgent is a quick-and-dirty mock trace agent used to inspect traces generated by Datadog tracers. It listens for HTTP requests containing MessagePack-encoded trace payloads and can display statistics and save payloads for inspection.

## Project Configuration

- **Target Framework**: .NET 9.0
- **Language Version**: latest C#
- **Nullable**: enabled
- **Key Dependencies**:
  - MessagePack (2.x) - for deserializing trace payloads
  - Spectre.Console.Cli (0.x) - for CLI argument parsing

## Build & Run Commands

```bash
# Build the project
dotnet build

# Run the application (default port 8126)
dotnet run

# Run with custom port
dotnet run -- --port 8080

# Show trace/span counts (requires deserialization)
dotnet run -- --show-counts

# Save raw payloads to files
dotnet run -- --save RawBytes

# Save payloads as JSON
dotnet run -- --save ConvertToJson

# Save both raw and JSON
dotnet run -- --save All

# Filter by URL (default: /traces)
dotnet run -- --url-filter /v0.4/traces
```

## Architecture

### Core Components

1. **Program.cs** - Entry point that configures Spectre.Console.Cli with `ListenCommand`

2. **ListenCommand.cs** - Main command handler (ListenCommand.cs:12)
   - Defines CLI options via `Settings` class (ListenCommand.cs:23)
   - Command options:
     - `--port` / `-p`: Port to listen on (default: 8126)
     - `--show-counts` / `-c`: Deserialize and display trace chunk/span counts
     - `--save` / `-s`: Save payloads (None/RawBytes/ConvertToJson/All)
     - `--url-filter` / `-f`: URL filter for processing (default: "/traces")
   - Instantiates `TraceAgent` and handles request callbacks (ListenCommand.cs:47)
   - `RequestReceived()` callback handles payload inspection and saving (ListenCommand.cs:91)

3. **TraceAgent.cs** - HTTP listener implementation (TraceAgent.cs:8)
   - Creates `HttpListener` on both 127.0.0.1 and localhost
   - Runs dedicated thread for handling HTTP requests (TraceAgent.cs:52)
   - Uses `ArrayPool<byte>` for efficient memory management when reading request bodies (TraceAgent.cs:69)
   - Returns simple `{}` JSON response to all requests (TraceAgent.cs:10)

4. **Span.cs** - MessagePack data model for Datadog spans (Span.cs:9)
   - Represents the Datadog trace span format with attributes:
     - `trace_id`, `span_id`, `parent_id`
     - `service`, `name`, `resource`, `type`
     - `start`, `duration`, `error`
     - `meta` (string tags), `metrics` (numeric values)

### Request Processing Flow

1. `TraceAgent` receives HTTP request on background thread (TraceAgent.cs:59)
2. If `readRequestBytes` is true, reads request body into pooled buffer (TraceAgent.cs:69)
3. Invokes callback with URL, content length, and memory buffer (TraceAgent.cs:79)
4. `ListenCommand.RequestReceived()` processes the request:
   - If `--show-counts` and URL is "/v0.4/traces", deserializes as `IList<IList<Span>>` to count trace chunks and spans (ListenCommand.cs:106)
   - If `--save` is set, saves payload to timestamped files (ListenCommand.cs:119, ListenCommand.cs:127)
5. Returns pooled buffer to `ArrayPool` (TraceAgent.cs:83)

### Datadog Trace Format

The agent expects MessagePack-encoded payloads at `/v0.4/traces` in the format:
- Top level: List of trace chunks (`IList<IList<Span>>`)
- Each trace chunk: List of spans belonging to the same trace
- Each span: Datadog span with attributes defined in Span.cs

Saved filenames use format: `payload-{url_part}-{timestamp}.{bin|json}`
- Example: `payload-v0.4_traces-2025-11-06_14-23-45-12.json`
