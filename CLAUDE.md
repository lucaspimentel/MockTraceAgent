# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

MockTraceAgent is a quick-and-dirty mock trace agent used to inspect traces generated by Datadog tracers. It listens for HTTP requests containing MessagePack-encoded trace payloads and can display statistics and save payloads for inspection.

The solution now consists of three projects:
- **MockTraceAgent.Cli** - CLI application for command-line trace inspection
- **MockTraceAgent.Web** - Web application with real-time trace visualization
- **MockTraceAgent.Core** - Shared library containing core trace processing logic

## Project Configuration

- **Target Framework**: .NET 9.0
- **Language Version**: latest C#
- **Nullable**: enabled
- **Key Dependencies**:
  - MessagePack (2.x) - for deserializing trace payloads
  - Spectre.Console.Cli (0.x) - for CLI argument parsing (CLI only)
  - SignalR (9.x) - for real-time web updates (Web only)

## Project Structure

```
MockTraceAgent/
├── MockTraceAgent.Cli.csproj          # CLI application project
├── Program.cs                          # CLI entry point
├── ListenCommand.cs                    # CLI command handler
├── MockTraceAgent.Core/
│   ├── MockTraceAgent.Core.csproj     # Shared library project
│   ├── TraceAgent.cs                  # HTTP listener implementation
│   └── Span.cs                        # MessagePack data model
└── MockTraceAgent.Web/
    ├── MockTraceAgent.Web.csproj      # Web application project
    ├── Program.cs                      # ASP.NET Core entry point
    ├── appsettings.json                # Configuration (TraceAgentPort)
    ├── Hubs/TracesHub.cs              # SignalR hub
    ├── Services/
    │   ├── TraceAgentHostedService.cs  # Background trace listener
    │   └── TraceStorageService.cs      # In-memory storage
    ├── Models/TraceData.cs            # Data models
    └── wwwroot/                        # Static web files
        ├── index.html
        ├── styles.css
        └── app.js
```

## Build & Run Commands

### Build All Projects

```bash
# Build entire solution
dotnet build

# Build specific projects
dotnet build MockTraceAgent.Cli.csproj
dotnet build MockTraceAgent.Core/MockTraceAgent.Core.csproj
dotnet build MockTraceAgent.Web/MockTraceAgent.Web.csproj
```

### CLI Application

```bash
# Run the CLI application (default port 8126)
dotnet run --project MockTraceAgent.Cli.csproj

# Run with custom port
dotnet run --project MockTraceAgent.Cli.csproj -- --port 8080

# Show trace/span counts (requires deserialization)
dotnet run --project MockTraceAgent.Cli.csproj -- --show-counts

# Save raw payloads to files
dotnet run --project MockTraceAgent.Cli.csproj -- --save RawBytes

# Save payloads as JSON
dotnet run --project MockTraceAgent.Cli.csproj -- --save ConvertToJson

# Save both raw and JSON
dotnet run --project MockTraceAgent.Cli.csproj -- --save All

# Filter by URL (default: /traces)
dotnet run --project MockTraceAgent.Cli.csproj -- --url-filter /v0.4/traces

# Combined example
dotnet run --project MockTraceAgent.Cli.csproj -- --port 8126 --show-counts --save All
```

### Web Application

```bash
# Run the web application
dotnet run --project MockTraceAgent.Web/MockTraceAgent.Web.csproj

# Web UI: http://localhost:5000
# Trace agent: port 8126 (configurable in appsettings.json)
```

**Important**: CLI and Web applications cannot run simultaneously on the same port. If both need to run, configure them to use different ports via `--port` (CLI) or `appsettings.json` (Web).

## Architecture

### MockTraceAgent.Core (Shared Library)

Core components shared between CLI and Web applications:

1. **TraceAgent.cs** - HTTP listener implementation
   - Creates `HttpListener` on both 127.0.0.1 and localhost
   - Runs dedicated thread for handling HTTP requests
   - Uses `ArrayPool<byte>` for efficient memory management when reading request bodies
   - Returns simple `{}` JSON response to all requests
   - Invokes callback with URL, content length, and memory buffer for each request

2. **Span.cs** - MessagePack data model for Datadog spans
   - Represents the Datadog trace span format with attributes:
     - `trace_id`, `span_id`, `parent_id`
     - `service`, `name`, `resource`, `type`
     - `start`, `duration`, `error`
     - `meta` (string tags), `metrics` (numeric values)

### MockTraceAgent.Cli (CLI Application)

1. **Program.cs** - Entry point that configures Spectre.Console.Cli with `ListenCommand`

2. **ListenCommand.cs** - Main command handler
   - Defines CLI options via `Settings` class
   - Command options:
     - `--port` / `-p`: Port to listen on (default: 8126)
     - `--show-counts` / `-c`: Deserialize and display trace chunk/span counts
     - `--save` / `-s`: Save payloads (None/RawBytes/ConvertToJson/All)
     - `--url-filter` / `-f`: URL filter for processing (default: "/traces")
   - Instantiates `TraceAgent` from Core library and handles request callbacks
   - `RequestReceived()` callback handles payload inspection and saving

### MockTraceAgent.Web (Web Application)

1. **Program.cs** - ASP.NET Core entry point
   - Configures SignalR for real-time updates
   - Registers services (TraceStorageService, TraceAgentHostedService)
   - Maps API endpoints and SignalR hub
   - Serves static files from wwwroot

2. **Services/TraceAgentHostedService.cs** - Background service
   - Starts `TraceAgent` from Core library on configured port
   - Routes received traces to `TraceStorageService`

3. **Services/TraceStorageService.cs** - In-memory trace storage
   - Stores received traces with deserialized span data
   - Broadcasts new traces to connected clients via SignalR
   - Provides API methods for retrieving traces, raw bytes, and JSON

4. **Hubs/TracesHub.cs** - SignalR hub for real-time updates
   - Broadcasts trace events to all connected web clients

5. **Models/TraceData.cs** - Data models
   - `TraceData`: Represents a received trace with metadata and spans
   - `TraceStatistics`: Aggregated statistics across all traces

6. **wwwroot/** - Static web frontend
   - **index.html**: Main UI with trace list and detail panels
   - **styles.css**: Styling for the web interface
   - **app.js**: JavaScript application logic
     - SignalR client for real-time updates
     - Trace list rendering
     - Span hierarchy visualization
     - JSON viewer
     - Download functionality for raw/JSON formats

### Request Processing Flow

#### CLI Application Flow
1. `TraceAgent` receives HTTP request on background thread
2. Reads request body into pooled buffer (if enabled)
3. Invokes callback with URL, content length, and memory buffer
4. `ListenCommand.RequestReceived()` processes the request:
   - If `--show-counts` and URL is "/v0.4/traces", deserializes as `IList<IList<Span>>` to count trace chunks and spans
   - If `--save` is set, saves payload to timestamped files
5. Returns pooled buffer to `ArrayPool`

#### Web Application Flow
1. `TraceAgent` receives HTTP request on background thread
2. Reads request body into pooled buffer
3. Invokes callback to `TraceStorageService.AddTrace()`
4. `TraceStorageService` processes the trace:
   - Deserializes MessagePack payload to `IList<IList<Span>>`
   - Stores trace data in memory with unique ID
   - Broadcasts trace event to all connected clients via SignalR
5. Web frontend receives SignalR event and updates UI in real-time
6. User can select traces to view detailed span hierarchy and download raw/JSON data

### Datadog Trace Format

The agent expects MessagePack-encoded payloads at `/v0.4/traces` in the format:
- Top level: List of trace chunks (`IList<IList<Span>>`)
- Each trace chunk: List of spans belonging to the same trace
- Each span: Datadog span with attributes defined in Span.cs

Saved filenames use format: `payload-{url_part}-{timestamp}.{bin|json}`
- Example: `payload-v0.4_traces-2025-11-06_14-23-45-12.json`

## Web Application Features

The web frontend provides:

1. **Real-time Trace Display**
   - Live updating list of received traces
   - SignalR-based push notifications for new traces
   - Statistics dashboard showing total traces, spans, and bytes

2. **Trace Visualization**
   - Hierarchical tree view of spans showing parent-child relationships
   - Visual indentation to represent trace structure
   - Color-coded error highlighting
   - Duration display in human-readable format

3. **Detailed Span Information**
   - Service, resource, type, and IDs
   - Tags (metadata) and metrics
   - Start time and duration
   - Error indicators

4. **Data Export**
   - Download raw MessagePack bytes (.bin)
   - Download converted JSON (.json)
   - JSON syntax-highlighted viewer in browser

5. **Connection Status**
   - Real-time connection status indicator
   - Automatic reconnection on network issues

## REST API Endpoints

The web application exposes a REST API for programmatic access to trace data.

### GET /api/traces
List all received traces (summary view).

**Response**: Array of trace summaries (most recent first)
```json
[
  {
    "id": "abc123...",
    "receivedAt": "2025-11-07 10:30:45.12",
    "url": "/v0.4/traces",
    "contentLength": 1024,
    "traceChunkCount": 5,
    "totalSpanCount": 23
  }
]
```

### GET /api/traces/{id}
Get detailed trace information including all spans.

**Response**: Full trace data (without raw bytes)
```json
{
  "id": "abc123...",
  "receivedAt": "2025-11-07T10:30:45.123",
  "url": "/v0.4/traces",
  "contentLength": 1024,
  "traceChunks": [[/* span objects */]],
  "traceChunkCount": 1,
  "totalSpanCount": 5
}
```

**Note**: Raw bytes are excluded from this response to reduce payload size. Use `/api/traces/{id}/raw` to download them.

### GET /api/traces/{id}/raw
Download raw MessagePack bytes for a trace.

**Response**: Binary file (application/octet-stream)
- Filename: `trace-{id}.bin`
- Content: Original MessagePack payload as received

### GET /api/traces/{id}/json
Download trace as JSON.

**Response**: JSON file (application/json)
- Filename: `trace-{id}.json`
- Content: MessagePack payload converted to JSON

### GET /api/stats
Get aggregate statistics.

**Response**: Statistics object
```json
{
  "totalTraces": 42,
  "totalSpans": 156,
  "totalBytes": 51200,
  "firstTraceAt": "2025-11-07T10:00:00.000",
  "lastTraceAt": "2025-11-07T10:30:45.123"
}
```

### SignalR Hub: /hubs/traces
Real-time events for connected clients.

**Event**: `ReceiveTrace` - Fired when new trace arrives
```javascript
connection.on("ReceiveTrace", (trace) => {
  // trace object contains: id, receivedAt, url, contentLength, traceChunkCount, totalSpanCount
});
```
